name: Deploy to GCP Cloud Run

on:
    push:
        branches:
            - master

jobs:
    build-and-deploy-qa:
        runs-on: ubuntu-latest

        env:
            PROJECT_ID: money-law-gep
            REGION: us-central1
            SERVICE_NAME: money-law-gep-backend-api-qa
            IMAGE_NAME: us-central1-docker.pkg.dev/money-law-gep/money-law-gep-backend-api-qa/money-law-gep-backend-api-qa

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Google Cloud CLI
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ env.PROJECT_ID }}

            - name: Authenticate Docker to Artifact Registry
              run: |
                  gcloud auth print-access-token | \
                  docker login -u oauth2accesstoken --password-stdin https://us-central1-docker.pkg.dev

            - name: Build Docker image
              run: |
                  docker build \
                    --platform=linux/amd64 \
                    -t $IMAGE_NAME \
                    --build-arg ENVIRONMENT=qa \
                    .

            - name: Push Docker image
              run: docker push $IMAGE_NAME

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy $SERVICE_NAME \
                    --image $IMAGE_NAME \
                    --platform managed \
                    --region $REGION \
                    --allow-unauthenticated \
                    --port 8080 \
                    --set-env-vars ENVIRONMENT=qa \
                    --update-secrets JWT_SECRET=JWT_SECRET:latest \
                    --update-secrets JWT_ISSUER=JWT_ISSUER:latest \
                    --update-secrets JWT_AUDIENCE=JWT_AUDIENCE:latest \
                    --update-secrets JWT_EXPIRES_IN=JWT_EXPIRES_IN:latest \
                    --update-secrets FRONTEND_URL=FRONTEND_URL:latest \
                    --update-secrets DB_NAME=DB_NAME:latest \
                    --update-secrets DB_HOST=DB_HOST:latest \
                    --update-secrets DB_PORT=DB_PORT:latest \
                    --update-secrets DB_USER=DB_USER:latest \
                    --update-secrets DB_PASSWORD=DB_PASSWORD:latest
